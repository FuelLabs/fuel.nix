<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>fuel.nix</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="welcome.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="nix-setup.html"><strong aria-hidden="true">3.</strong> Nix Setup</a></li><li class="chapter-item expanded "><a href="packages.html"><strong aria-hidden="true">4.</strong> Packages</a></li><li class="chapter-item expanded "><a href="nix-power-users.html"><strong aria-hidden="true">5.</strong> Nix Power Users</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="nix-power-users/dev-shells.html"><strong aria-hidden="true">5.1.</strong> Dev Shells</a></li><li class="chapter-item expanded "><a href="nix-power-users/overlays.html"><strong aria-hidden="true">5.2.</strong> Overlays</a></li><li class="chapter-item expanded "><a href="nix-power-users/editor-plugins.html"><strong aria-hidden="true">5.3.</strong> Editor Plugins</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">6.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributing/internals.html"><strong aria-hidden="true">6.1.</strong> Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="contributing/internals/generating-manifests.html"><strong aria-hidden="true">6.1.1.</strong> Generating Manifests</a></li><li class="chapter-item expanded "><a href="contributing/internals/providing-packages.html"><strong aria-hidden="true">6.1.2.</strong> Providing Packages</a></li><li class="chapter-item expanded "><a href="contributing/internals/providing-milestones.html"><strong aria-hidden="true">6.1.3.</strong> Providing Milestones</a></li></ol></li><li class="chapter-item expanded "><a href="contributing/adding-packages.html"><strong aria-hidden="true">6.2.</strong> Adding Packages</a></li><li class="chapter-item expanded "><a href="contributing/updating-packages.html"><strong aria-hidden="true">6.3.</strong> Updating Packages</a></li><li class="chapter-item expanded "><a href="contributing/updating-flake-inputs.html"><strong aria-hidden="true">6.4.</strong> Updating Flake Inputs</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">fuel.nix</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="welcome"><a class="header" href="#welcome">Welcome</a></h1>
<p><strong>fuel.nix</strong> provides an easy, reliable way of using Fuel tools.</p>
<p>Each night at midnight (UTC) <a href="fuel.nix"><strong>the fuel.nix repo</strong></a> is automatically
updated with the latest stable and nightly releases of all fuel packages. Builds
are tested and cached for both <strong>Linux</strong> and <strong>macOS</strong> systems.</p>
<p>Check out the <a href="./quick-start.html"><strong>Quick Start</strong></a> to dive in!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<p>Let's install both Nix and the latest full suite of Fuel tools in just two
commands.</p>
<h2 id="install-nix"><a class="header" href="#install-nix">Install Nix</a></h2>
<p>Nix is a package manager with a focus on reproducibility and reliability. We can
install it and enable the Fuel Labs binary cache with the following:</p>
<pre><code class="language-console">curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix/tag/v0.9.0 | sh -s -- install --extra-conf "extra-substituters = https://fuellabs.cachix.org" --extra-conf "extra-trusted-public-keys = fuellabs.cachix.org-1:3gOmll82VDbT7EggylzOVJ6dr0jgPVU/KMN6+Kf8qx8="
</code></pre>
<blockquote>
<p><strong>Note:</strong> For more details on Nix installation or how to configure an existing
Nix or NixOS installation, see the detailed
<a href="./nix-setup.html"><strong>Nix Setup</strong></a> chapter.</p>
</blockquote>
<h2 id="install-fuel"><a class="header" href="#install-fuel">Install Fuel</a></h2>
<p>After installing Nix, open a new terminal and install the stable Fuel toolchain
in a temporary shell with the following:</p>
<pre><code class="language-console">nix shell github:fuellabs/fuel.nix#fuel-testnet
</code></pre>
<p>This will download the latest release of <code>fuel-core</code>, <code>forc</code>, compatible with
the testnet network and a suite of other tools from the Fuel Labs cache into the
local <code>/nix/store</code> cache and "install" them to <code>PATH</code> for the duration of the
current shell.</p>
<p>Let's check installation worked:</p>
<pre><code class="language-console">$ fuel-core --version
fuel-core 0.26.0

$ forc --version
forc 0.60.0
</code></pre>
<blockquote>
<p><strong>Note:</strong> If you have previously installed Fuel tools using <code>cargo</code>, <code>fuelup</code>
or some other means, it is recommended to double check your <code>PATH</code> to make
sure you are using those installed by Nix.</p>
<pre><code class="language-console">echo $PATH
</code></pre>
<p>Your console will always use the first version of an executable that appears
in your <code>PATH</code>.</p>
</blockquote>
<p>Now we're ready to build with Fuel!</p>
<p>We can <code>exit</code> the current shell to remove the tools from our <code>PATH</code> as if they
were never installed.</p>
<h2 id="diving-deeper"><a class="header" href="#diving-deeper">Diving Deeper</a></h2>
<p>To find out how to install tools persistently for the current user, how to
install different toolchain channels (nightly, testnet, etc), how to install
individual components, along with a whole suite of other options, see <a href="./packages.html"><strong>the
Packages chapter</strong></a>.</p>
<p>For more details on installing Nix or configuring an existing Nix or NixOS
installation, see <a href="./nix-setup.html"><strong>the Nix Setup chapter</strong></a>.</p>
<p>If you are content with the installation, see the
<a href="https://docs.fuel.network/"><strong>Documentation Portal</strong></a>
for more details on how to build with Fuel!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-setup"><a class="header" href="#nix-setup">Nix Setup</a></h1>
<p><a href="https://nixos.org/"><strong>Nix</strong></a> is a package manager with a focus on
reproducibility and reliability. Fuel Labs leverages Nix to provide a simple
way to natively install the ecosystem tooling along with any necessary system
dependencies and environment setup.</p>
<p>This chapter provides a more detailed look at the Nix installation process,
describes how to setup an existing Nix configuration, and covers how to
uninstall Nix and its installed packages if necessary.</p>
<h2 id="install-nix-1"><a class="header" href="#install-nix-1">Install Nix</a></h2>
<p>To recap our <a href="./quick-start.html">Quick Start</a>, we can install Nix with the
following command:</p>
<pre><code class="language-console">curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix/tag/v0.9.0 | sh -s -- install --extra-conf "extra-substituters = https://fuellabs.cachix.org" --extra-conf "extra-trusted-public-keys = fuellabs.cachix.org-1:3gOmll82VDbT7EggylzOVJ6dr0jgPVU/KMN6+Kf8qx8="
</code></pre>
<p>This uses the <a href="nix-installer"><code>nix-installer</code> tool by Determinate Systems</a> to
install Nix with the <a href="nix-flakes"><strong>flakes</strong></a> and <a href="nix-command"><strong>nix-command</strong></a>
features enabled, and provides <code>--extra-conf</code> flags that enable <a href="fuel-labs-cache">the Fuel Labs
binary cache</a>.</p>
<blockquote>
<p><strong>Note:</strong> Without a binary cache, Nix will build everything from source on
first use. This can take a long time! The fuel.nix repo CI builds all channels
(published, nightly, milestones) and provides a cache so you don't have to.</p>
</blockquote>
<p>The installer will first present an installation plan before prompting
to continue. Feel free to review or prompt for further explanation before
proceeding with installation.</p>
<p>After continuing, Nix installation should complete within a few seconds. Be sure
to open a new terminal before using <code>nix</code>.</p>
<h2 id="configuring-an-existing-nix-installation"><a class="header" href="#configuring-an-existing-nix-installation">Configuring an Existing Nix Installation</a></h2>
<p>If you're an existing Nix user you can enable the necessary features along
with the Fuel Labs binary cache with the following additions to your Nix
configuration (<code>/etc/nix/nix.conf</code>):</p>
<pre><code>experimental-features = nix-command flakes
extra-substituters = https://fuellabs.cachix.org
extra-trusted-public-keys = fuellabs.cachix.org-1:3gOmll82VDbT7EggylzOVJ6dr0jgPVU/KMN6+Kf8qx8=
</code></pre>
<h2 id="configuring-nixos"><a class="header" href="#configuring-nixos">Configuring NixOS</a></h2>
<p>Similarly, if you're an existing <a href="https://nixos.org/">NixOS</a> user, you can
update your nixos configuration with the following:</p>
<pre><code class="language-nix">{
  nix = {
    settings = {
      experimental-features = ["nix-command" "flakes"];
      extra-substituters = ["https://fuellabs.cachix.org"];
      extra-trusted-public-keys = [
        "fuellabs.cachix.org-1:3gOmll82VDbT7EggylzOVJ6dr0jgPVU/KMN6+Kf8qx8="
      ];
    };
  };
}
</code></pre>
<h2 id="trouble-shooting"><a class="header" href="#trouble-shooting">Trouble Shooting</a></h2>
<h3 id="nix-command-not-available"><a class="header" href="#nix-command-not-available">Nix command not available</a></h3>
<p>The daemon that makes nix available to your shell is not run automatically after installation. You'll need to either manually start it in your shell instance with <code>nix daemon</code> or open a new instance of your shell. If it persists, log out, log back in and open a new terminal.</p>
<h3 id="nix-isnt-using-the-fuel-cache"><a class="header" href="#nix-isnt-using-the-fuel-cache">Nix isn't using the Fuel cache</a></h3>
<p>In some cases, usually in existing nix installations, nix may have trouble finding or using the cache. This could happen for a few reasons:</p>
<h4 id="confirm-you-are-a-trusted-user"><a class="header" href="#confirm-you-are-a-trusted-user">Confirm you are a trusted user:</a></h4>
<p>The user the request is coming from may not be a trusted user, in which case some permissions may be missing to use parts of the configuration.
There is a great example of this in the Nix discourse which can be found <a href="https://discourse.nixos.org/t/nix-flake-and-trusted-users/8882">here</a> that also provides a solution if you want certain features available to untrusted users.</p>
<h4 id="the-extra-substitutors-section-is-overlooked"><a class="header" href="#the-extra-substitutors-section-is-overlooked">The <code>extra-substitutors</code> section is overlooked:</a></h4>
<p><code>extra-substitutors</code> appends additional caches to those already specified by <code>substitutors</code>, and will silently ignore them when they are attempted to be used by unprivileged users. If the output of <code>nix show-config</code> does not show the Fuel cache in <code>extra-substitutors</code> after <a href="nix-setup.html#confirm-you-are-a-trusted-user">confirming you are a trusted user</a>, you may need to restart your shell. If this still does not solve the issue, try adding the Fuel cachix link to <code>substitutors</code> instead, separating any existing substitutors by whitespace.</p>
<h4 id="negative-caching"><a class="header" href="#negative-caching">Negative caching:</a></h4>
<p>If you ran into any of the previous problems, which made your system build a derivation from source, you may experience <a href="https://en.wikipedia.org/wiki/Negative_cache">negative caching</a> in which case you'll need to <a href="https://nix.dev/recipes/faq#how-do-i-force-nix-to-re-check-whether-something-exists-at-a-binary-cache">reset the lookup cache</a> that nix uses to check if a cache doesn't exist.</p>
<p>If a problem persists after trying the above please <a href="https://github.com/FuelLabs/fuel.nix/issues/new">open an issue</a>.</p>
<h2 id="uninstall-everything"><a class="header" href="#uninstall-everything">Uninstall Everything</a></h2>
<p>If you installed Nix using the Determinate Systems nix-installer tool as
described in this guide, you can uninstall Nix along with all nix-installed
packages with the following:</p>
<pre><code class="language-console">/nix/nix-installer uninstall
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="packages"><a class="header" href="#packages">Packages</a></h1>
<p>The <code>fuel.nix</code> flake provides the following packages:</p>
<div class="table-wrapper"><table><thead><tr><th>Package</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/fuellabs/fuel-core"><code>fuel-core</code></a></td><td>The Fuel VM node client.</td></tr>
<tr><td><a href="https://github.com/fuellabs/fuel-core"><code>fuel-core-client</code></a></td><td>A Fuel VM transaction client.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc</code></a></td><td>The Fuel Orchestrator. Compiler, packaging and plugin support.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-client</code></a></td><td>Provides the <code>forc deploy</code> and <code>forc run</code> commands.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-crypto</code></a></td><td>A Forc plugin for hashing arbitrary data.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-debug</code></a></td><td>A Forc plugin for debugging via CLI and IDE.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-doc</code></a></td><td>Sway API documentation generator.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-fmt</code></a></td><td>The Sway code formatter.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-lsp</code></a></td><td>The Sway Language Server Protocol implementation.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway"><code>forc-tx</code></a></td><td>Construct transactions with a CLI.</td></tr>
<tr><td><a href="https://github.com/fuellabs/forc-wallet"><code>forc-wallet</code></a></td><td>A Fuel Wallet CLI implementation.</td></tr>
<tr><td><a href="https://github.com/fuellabs/sway.vim"><code>sway-vim</code></a></td><td>The Sway Vim plugin.</td></tr>
<tr><td><code>fuel</code></td><td>All of the above tools under a single package.</td></tr>
</tbody></table>
</div>
<h2 id="running-packages"><a class="header" href="#running-packages">Running Packages</a></h2>
<p>You can run any of the above programs without installing them like so:</p>
<pre><code>nix run github:fuellabs/fuel.nix#fuel-core
</code></pre>
<p>To run the latest nightly for a package, add <code>-nightly</code> to the end, e.g.</p>
<pre><code>nix run github:fuellabs/fuel.nix#forc-nightly
</code></pre>
<p>Similarly, run the version of a package from a milestone with <code>-&lt;milestone&gt;</code>, e.g.</p>
<pre><code>nix run github:fuellabs/fuel.nix#forc-lsp-testnet
</code></pre>
<pre><code>nix run github:fuellabs/fuel.nix#forc-wallet-testnet
</code></pre>
<h2 id="temporary-shells"><a class="header" href="#temporary-shells">Temporary Shells</a></h2>
<p>To enter a temporary shell with all of the fuel packages available on <code>$PATH</code>,
you can use the following:</p>
<pre><code>nix shell github:fuellabs/fuel.nix#fuel
</code></pre>
<p>When you <code>exit</code> the shell the tools will no longer be on the <code>PATH</code>.</p>
<p>The <code>nix shell</code> command is useful for maintaining isolated, temporary
environments and to avoid endlessly polluting your <code>PATH</code> with different
versions. E.g. in the following, we trivially switch between a stable fuel
toolchain and nightly toolchain:</p>
<pre><code class="language-sh">$ nix shell github:fuellabs/fuel.nix#fuel

# All latest stable `fuel` packages on `PATH`.

$ exit

# No fuel packages on `PATH`

$ nix shell github:fuellabs/fuel.nix#fuel-nightly

# All latest nightly `fuel` packages on `PATH`.

$ exit

# No fuel packages on `PATH`

$ nix shell github:fuellabs/fuel.nix#fuel-testnet

# All testnet milestone `fuel` packages on `PATH`.
</code></pre>
<h2 id="installing-packages"><a class="header" href="#installing-packages">Installing Packages</a></h2>
<p>To install fuel packages persistently for the current user:</p>
<pre><code class="language-console">nix profile install github:fuellabs/fuel.nix#fuel
</code></pre>
<p>To view whats installed for the current user:</p>
<pre><code class="language-console">nix profile list
</code></pre>
<p>To upgrade all installed packages to their latest versions:</p>
<pre><code class="language-console">nix profile upgrade
</code></pre>
<p>You can optionally specify a specific package to upgrade.</p>
<p>To remove an installed package:</p>
<pre><code class="language-console">nix profile remove 3
</code></pre>
<p>where <code>3</code> is the index of the package when running <code>nix profile list</code>.</p>
<p>For more options around managing nix user profiles, see <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-profile.html">the
docs</a>.</p>
<blockquote>
<p><strong>NOTE:</strong> If a previous version of Nix was installed on the system, the
<code>nix profile</code> command may not work due to an old symlink being present in $HOME.
See <a href="https://github.com/DeterminateSystems/nix-installer/issues/477"><strong>this issue</strong></a>.
If you encounter this issue, you can remedy it by deleting the <code>~/.nix-profile</code>
symlink so that the <code>nix profile</code> commands can recreate it with the correct
path.</p>
</blockquote>
<h2 id="specifying-versions"><a class="header" href="#specifying-versions">Specifying Versions</a></h2>
<p>To specify a specific version, append the semver or nightly date to the end:</p>
<pre><code>nix run github:fuellabs/fuel.nix#forc-fmt-0-24-1
</code></pre>
<pre><code>nix run github:fuellabs/fuel.nix#forc-fmt-0-24-3-nightly-2022-09-14
</code></pre>
<blockquote>
<p><strong>Note:</strong> that when building an older version or nightly, they may no longer
be available in the binary cache and may need to be rebuilt!</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-power-users"><a class="header" href="#nix-power-users">Nix Power Users</a></h1>
<p><strong>fuel.nix</strong> offers some tools that may be more useful for existing Nix and
NixOS power users.</p>
<p>This chapter is targeted towards more experienced Nix users who use Nix to
configure their home or NixOS systems (e.g. using home-manager or NixOS
configuration).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dev-shells"><a class="header" href="#dev-shells">Dev Shells</a></h1>
<p><strong>fuel.nix</strong> also features a few <code>devShell</code>s that make it easy to drop into a
development shell for working on the fuel packages. They allow you to drop into
a temporary shell with all the tools and environment variables required to build
the various fuel projects yourself.</p>
<div class="table-wrapper"><table><thead><tr><th>Dev Shell</th><th>Description</th></tr></thead><tbody>
<tr><td><code>fuel-core-dev</code></td><td>A shell for working on the <code>fuel-core</code> repo.</td></tr>
<tr><td><code>sway-dev</code></td><td>A shell for working on the <code>sway</code> repo.</td></tr>
<tr><td><code>fuel-dev</code></td><td>A shell ready for working with on any Fuel repo.</td></tr>
</tbody></table>
</div>
<p>You can enter a temporary dev shell like so:</p>
<pre><code>nix develop github:fuellabs/fuel.nix#fuel-dev
</code></pre>
<p>Note that you can also enter a dev shell for individual packages. E.g. the
following enters a dev shell with the required environment for working on the
Sway language server implementation</p>
<pre><code>nix develop github:fuellabs/fuel.nix#forc-lsp
</code></pre>
<p>Currently the vim plugin still needs to be installed separately. See
<a href="nix-power-users/./overlays.html">the Overlays chapter</a> and the <a href="https://nixos.wiki/wiki/Vim">Nix Vim wiki</a>
for more details.</p>
<blockquote>
<p><strong>Note:</strong> While these <code>devShell</code>s might be useful to get started on developing
fuel packages, ideally each upstream package would provide its own <code>devShell</code>
so that it may iterate on its own shell with more freedom (without editing these
downstream <code>devShell</code>s).</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overlays"><a class="header" href="#overlays">Overlays</a></h1>
<p>Two nixpkgs <a href="https://nixos.wiki/wiki/Overlays">overlays</a> are provided (<code>fuel</code> and <code>fuel-nightly</code>) that allow for
"merging" the set of packages provided by this flake with nixpkgs.</p>
<p>Note that this makes the <code>sway-vim</code> plugin accessible via the <code>vimPlugins</code> set
following the nixpkgs convention, e.g. <code>nixpkgs.vimPlugins.sway-vim</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="editor-plugins"><a class="header" href="#editor-plugins">Editor Plugins</a></h1>
<p>Currently this flake and <a href="nix-power-users/./overlays.html">its overlay</a> only provide the
<code>sway-vim</code> Vim plugin.</p>
<p>Contributions adding support for other editors/IDE plugins are more than
welcome!</p>
<p>In the meantime, you can <a href="https://marketplace.visualstudio.com/items?itemName=FuelLabs.sway-vscode-plugin">install the Sway VS Code plugin from the
marketplace</a> as per usual.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>This chapter will cover the internals of <strong>fuel.nix</strong>, how it works, and how
to contribute!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="internals"><a class="header" href="#internals">Internals</a></h1>
<p>At a very high level, <strong>fuel.nix</strong> does the following:</p>
<ol>
<li><a href="contributing/./internals/generating-manifests.html"><strong>Generate unique "manifests" for each version of each package</strong></a>
every night at 00:00 UTC under the <code>./manifests</code> directory using a CI action
that runs the <code>./scripts/refresh-manifests.sh</code> script.</li>
<li><a href="contributing/./internals/providing-packages.html"><strong>Provide <code>package</code> flake outputs</strong></a>
(e.g. <code>forc-0-20-0</code>, <code>fuel-core-0-18-0-nightly-2023-04-29</code>) by collecting,
filtering (<code>filters.nix</code>) and patching (<code>patches.nix</code>) all manifests. Also
provide package <strong>sets</strong> for the latest semver releases and nightlies e.g.
(<code>fuel-latest</code>, <code>fuel-nightly</code>).</li>
<li><a href="contributing/./internals/providing-milestones.html"><strong>Provide a special set of "milestone" packages</strong></a>
(e.g. <code>forc-wallet-testnet</code>) and package sets (e.g. <code>fuel-testnet</code>) by finding
packages that match the commits specified in <code>milestones.nix</code>.</li>
<li><strong>Provide <code>devShell</code>s</strong> to assist working on the fuel repos by collecting all
of the inputs to their associated packages and inheriting their environment
variables.</li>
</ol>
<p>Click on the links above to dive into more details on each step.</p>
<p>Alternatively, for a quick look at adding or updating packages:</p>
<ul>
<li><a href="contributing/./adding-packages.html"><strong>Adding Packages</strong></a></li>
<li><a href="contributing/./updating-packages.html"><strong>Updating Packages</strong></a></li>
<li><a href="contributing/./updating-flake-inputs.html"><strong>Updating Flake Inputs</strong></a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generating-manifests"><a class="header" href="#generating-manifests">Generating Manifests</a></h1>
<p>In <strong>fuel.nix</strong>, "Manifests" are small nix files that declare some unique
properties for a particular version of a particular package. These manifests
are used by <code>flake.nix</code> to provide all of the fuel packages in a declarative,
reproducible manner.</p>
<p>Here's an example of what a manifest looks like:</p>
<pre><code class="language-nix">{
  pname = "fuel-core";
  version = "0.18.0";
  date = "2023-04-27";
  url = "https://github.com/fuellabs/fuel-core";
  rev = "19f12eab187928cf15289193c710f63417343d33";
  sha256 = "sha256-FD9GbSxPhXAWrl40I9lzmEHQ4R2FD3ECYKmipfRPhlU=";
}
</code></pre>
<h2 id="refreshing-manifests-on-ci"><a class="header" href="#refreshing-manifests-on-ci">Refreshing Manifests on CI</a></h2>
<p>Each night at 00:00 UTC, the <code>fuel.nix</code> repo's <code>refresh-manifests</code> GitHub action
runs the <code>./scripts/refresh-manifests.sh</code> script.</p>
<p>The role of this script is to fetch each of the FuelLabs GitHub repositories,
scan them for all versioned releases (by checking their git tags) and for all
nightly releases (by checking timestamps) in order to generate a unique manifest
for every version of every package and store them under the <code>./manifests/</code>
directory.</p>
<p>The GitHub action checks the diff to see if there are any new manifests since
the previous night. If so, it attempts to build and cache them on each supported
platform. Upon success, the action commits the new manifests directly to the
<code>master</code> branch.</p>
<h2 id="refreshing-manifests-locally"><a class="header" href="#refreshing-manifests-locally">Refreshing Manifests Locally</a></h2>
<p>As a maintainer, you can run the script locally by cloning the repository,
<code>cd</code>ing into the repo and running:</p>
<pre><code class="language-console">nix run .#refresh-manifests
</code></pre>
<p>Running the script like this will ensure you have access to the necessary tools.
These include <code>git</code>, <code>coreutils</code> (for the <code>date</code> cmd), <code>nix</code> (used to generate
the package src sha256 hashes) and <code>semver-tool</code> (used to validate the semver
retrieved from git tags).</p>
<p>After running the script, you can use <code>git status</code> to see if any new manifests
have been generated. You can commit and open a PR with these changes at any
time, or simply wait for the next nightly <code>refresh-manifests</code> GitHub action
to run.</p>
<h2 id="notes-on-scriptsrefresh-manifestssh"><a class="header" href="#notes-on-scriptsrefresh-manifestssh">Notes on <code>./scripts/refresh-manifests.sh</code></a></h2>
<p>The script begins by declaring all FuelLabs repositories that we care about,
followed by each unique package and which repository it is associated with.
To declare new packages, see the
<a href="contributing/internals/./contributing/adding-packages.html">Adding Packages</a> chapter.</p>
<p>The script aims to be idempotent, i.e. even if you were to delete the entire
<code>./manifests</code> directory and all its manifests, running the script again should
reproduce the exact same directory with the same set of manifests, assuming
the git history of each of the FuelLabs repos was not edited in some manner.</p>
<p>Running the script can take a long time. This is because we scan each
repository in its entirety multiple times - once while generating nightly
manifests, and again while generating semver release manifests.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="providing-packages"><a class="header" href="#providing-packages">Providing Packages</a></h1>
<p><strong>fuel.nix</strong> provides packages as <a href="https://nixos.wiki/wiki/Flakes">Nix flake <code>package</code> outputs</a>.</p>
<h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>The way in which <strong>fuel.nix</strong> creates package outputs is as follows:</p>
<ol>
<li>Load all manifests from the <code>./manifests/</code> directory (see <a href="contributing/internals/./generating-manifests.html">Generating
Manifests</a>).</li>
<li>Filter out manifests for package versions that are known to be broken, or
untested versions that are older than <strong>fuel.nix</strong> itself, by applying the
list of conditions in <code>./filters.nix</code>.</li>
<li>Patch the remaining manifests with their necessary build inputs (e.g.
openssl, rust, etc) and environment variables based on the list of patches in
<code>./patches.nix</code>.</li>
<li>Split manifests into <code>published</code> (e.g. <code>forc-0-28-0</code>) and <code>nightly</code> (e.g.
<code>fuel-core-0-18-0-nightly-2023-05-04</code>) sets based on their file suffix.</li>
<li>Pass the resulting sets of manifests to <code>mkPackages</code> and use the
<a href="https://github.com/NixOS/nixpkgs/blob/58c85835512b0db938600b6fe13cc3e3dc4b364e/doc/languages-frameworks/rust.section.md"><code>buildRustPackage</code></a> function to build a unique package
for each.</li>
<li>Create special packages for each package <em>set</em> using
<a href="https://nixos.org/manual/nixpkgs/stable/#trivial-builder-symlinkJoin"><code>symlinkJoin</code></a>, e.g. <code>fuel-latest</code> (aliased to <code>fuel</code>) and
<code>fuel-nightly</code>.</li>
</ol>
<p>The following shares some more details on each stage.</p>
<h1 id="filtering-manifests"><a class="header" href="#filtering-manifests">Filtering Manifests</a></h1>
<p>After loading all manifests into a list by reading them from the
<code>./manifests/</code> directory, we first apply the filters to cull versions that are
known to be broken or that are too old.</p>
<p>Filters are a list of conditions loaded from the <code>./filters.nix</code> file. Only
manifests that satisfy all of these conditions will be used to provide
packages.</p>
<p>Conditions are functions where given a manifest <code>m</code>, return whether or not the
manifest should be included.</p>
<p>The following is an example of one of the conditions in <code>./filters.nix</code>:</p>
<pre><code class="language-nix">  (m: m.pname != "forc" || versionAtLeast m.version "0.19.0")
</code></pre>
<p>This condition implies that only <code>forc</code> versions that are at least <code>0.19.0</code>
or greater will be included. This means <code>nix build .#forc-0-19-0</code> should work,
though <code>nix build .#forc-0-17-0</code> will not.</p>
<h1 id="patching-manifests"><a class="header" href="#patching-manifests">Patching Manifests</a></h1>
<p>After filtering out unnecessary or known-broken manifests, we build up the
remaining manifests by applying the list of patches loaded from <code>./patches.nix</code>.</p>
<p>Each patch includes:</p>
<ol>
<li>A <code>condition</code> that must be met for the patch to be applied and</li>
<li>A <code>patch</code> function that provides the extra attributes that should be merged
into the existing manifest.</li>
</ol>
<p>All patches are applied to all manifests in the order in which they are declared
in the <code>patches.nix</code> list, provided that they meet the patch's condition.</p>
<h3 id="using-patches-to-fix-manifests"><a class="header" href="#using-patches-to-fix-manifests">Using Patches to Fix Manifests</a></h3>
<p>The following is an example taken from <code>patches.nix</code> that applies a fix for a
known broken <code>forc-wallet</code> version:</p>
<pre><code class="language-nix">  # A patch for some `forc-wallet` nightlies whose committed `Cargo.lock` file
  # was out of date.
  {
    condition = m: m.pname == "forc-wallet" &amp;&amp; m.version == "0.1.0" &amp;&amp; m.date &lt; "2022-09-04";
    patch = m: {
      cargoPatches = [
        ./patch/forc-wallet-0.1.0-update-lock.patch
      ];
      cargoHash = "sha256-LXQaPcpf/n1RRFTQXAP6PexfEI67U2Z5OOW5DzNJvX8=";
      cargoLock = null;
    };
  }
</code></pre>
<p>As the condition suggests, the patch is only applied to <code>forc-wallet</code> manifests
with a version equal to <code>0.1.0</code> and whose commit date precedes 2022-09-04.</p>
<h3 id="using-patches-to-extend-manifests"><a class="header" href="#using-patches-to-extend-manifests">Using Patches to Extend Manifests</a></h3>
<p>Patches are not only used to <em>fix</em> existing manifests, but also to build up
commonly required attributes in a simple manner. For example, the following
patch is the first patch in the list:</p>
<pre><code class="language-nix">  # By default, most packages have their `Cargo.lock` file in the repo root.
  # We also specify a base, minimum Rust version. This version should never
  # change in order to avoid invalidating the cache for all previously built
  # packages. Instead, if a new version of a fuel package requires a newer
  # version of Rust, we should specify the necessary condition in a new patch
  # to ensure only newer packages use the newer version of Rust.
  {
    condition = m: true;
    patch = m: {
      cargoLock.lockFile = "${m.src}/Cargo.lock";
      meta.homepage = m.src.gitRepoUrl;
      rust = pkgs.rust-bin.stable."1.63.0".default;
    };
  }
</code></pre>
<p>As the condition implies, this patch is currently applied to <em>all</em> manifests.
The patch function provides some commonly useful attributes for building Rust
packages, i.e. the common location for the lock file, the default version of
Rust, and some package metadata about where the repository is located.</p>
<blockquote>
<p><strong>Note:</strong> This condition may need to be changed in the future when aiming to
support distributing non-Rust Fuel projects from <code>fuel.nix</code>.</p>
</blockquote>
<h3 id="adding-or-changing-patches"><a class="header" href="#adding-or-changing-patches">Adding or Changing Patches</a></h3>
<p>In general, it is better to add new patches with conditions that only apply to
newer packages when accounting for newly introduced dependencies or changes to
a package's build environment.</p>
<p>This approach ensures we don't accidentally break older versions of packages,
and allows us to isolate each change clearly with its own entry in the list.</p>
<p>Here's a patch that was added to account for an update in the Rust version used:</p>
<pre><code class="language-nix">  # `fuel-core` needs Rust 1.64 as of bcb86da09b6fdce09f13ef4181a0ca6461f8e2a8.
  # This changes the Rust used for all pkgs to 1.64 from the day of the commit.
  {
    condition = m: m.date &gt;= "2022-09-23";
    patch = m: {
      rust = pkgs.rust-bin.stable."1.64.0".default;
    };
  }
</code></pre>
<p>It avoids breaking older versions by only applying the patch to manifests whose
commits after dated after 2022-09-23.</p>
<h3 id="overriding-attributes"><a class="header" href="#overriding-attributes">Overriding Attributes</a></h3>
<p>The example above also demonstrates how attributes can be overridden. In the
previous patch example above, the <code>rust</code> attribute was set to version <code>1.63.0</code>,
however the patch above overrides this attribute for all manifests created on or
after 2023-09-23, setting the version to <code>1.64.0</code>.</p>
<p>Multiple Rust version changes can be found throughout <code>patches.nix</code> that
override the version following a particular date.</p>
<h1 id="building-packages"><a class="header" href="#building-packages">Building Packages</a></h1>
<p>Now that we have our final sets of manifests, we can build our flake's package
outputs from them.</p>
<p>This involves mapping the manifests we constructed with the <code>buildRustPackage</code>
function provided by the Rust platform. This is all performed within the flake's
<code>mkPackages</code> function.</p>
<p>Package outputs are created for the published and nightly releases of each
individual package (e.g. <code>forc-0-28-0</code>, <code>fuel-core-0-18-0-nightly-2023-05-04</code>).</p>
<blockquote>
<p><strong>Note:</strong> The use of hyphens for delineating semver versions rather than
periods! This can be a common gotcha when trying to use packages. E.g. <code>nix run .#forc-0.18.0</code> is invalid, but <code>nix run .#forc-0-18-0</code> is valid.</p>
</blockquote>
<h3 id="package-sets"><a class="header" href="#package-sets">Package Sets</a></h3>
<p>Unique packages are also created for each of the common package <em>sets</em>. These
can be thought of as packages that provide multiple other packges at once.</p>
<p>Most notably, we provide:</p>
<ul>
<li><strong><code>fuel</code></strong> (aliased from <code>fuel-latest</code>) - Provides the latest semver version
of every Fuel tool.</li>
<li><strong><code>fuel-nightly</code></strong> - Provides the latest nightly version of every Fuel tool.</li>
</ul>
<p>Sets are also provided for each milestone, however this is covered in the
<a href="contributing/internals/./providing-milestones.html">Providing Milestones</a> chapter.</p>
<h3 id="other-packages"><a class="header" href="#other-packages">Other Packages</a></h3>
<p>While <code>mkPackages</code> mostly focuses on generating package outputs for all of
Fuel's Rust packages, it also provides a couple of "hand-written" packages:</p>
<ol>
<li><code>refresh-manifests</code> - This is a small package for the script used to refresh
the manifests under the <code>./manifests/</code> directory.</li>
<li><code>sway-vim</code> - A Vim plugin derivation for NixOS or Nix home-manager users who
want to configure Vim in their Nix configuration.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="providing-milestones"><a class="header" href="#providing-milestones">Providing Milestones</a></h1>
<p><strong>fuel.nix</strong> allows for declaring "milestones".</p>
<p>Milestones provide a way of pinning a significant set of hand-picked commits
across the Fuel ecosystem under a single named release.</p>
<p>Milestones are provided by the <code>./milestones.nix</code> file.</p>
<p>Each milestone is a mapping from a name to a set of repository commits, each of
which is used to select the set of package manifests used to generate package
outputs for the milestone.</p>
<p>Here's what the <code>beta-2</code> milestone looks like:</p>
<pre><code class="language-nix">  beta-2 = {
    forc-explorer = "4bb7392eed085ee3a6795b98ea25392b3f41ade8";
    forc-wallet = "9473052e88048f58e8c4e1eba0ff88ef6a4cdd59";
    fuel-core = "49e4305fea691bbf293c606334e7b282a54393b3";
    fuel-indexer = "c2425c8b63f01ef1b540ff3e5832ebdc018b951d";
    sway = "c32b0759d25c0b515cbf535f9fb9b8e6fda38ff2";
  };
</code></pre>
<p>While <a href="contributing/internals/./providing-packages.html">providing packages</a>, milestones are used to
provide a unique output for each package along with a dedicated package set.
E.g. the above <code>beta-2</code> milestone is used to provide <code>fuel-core-beta-2</code> and
<code>forc-beta-2</code> package aliases, as well as the extra <code>fuel-beta-2</code> package set.</p>
<h1 id="adding-milestones"><a class="header" href="#adding-milestones">Adding milestones</a></h1>
<h3 id="choosing-commits"><a class="header" href="#choosing-commits">Choosing Commits</a></h3>
<p>When selecting commits from each repository for a new milestone, it can be
a good idea to do so from the top-down. I.e. First select a commit for the
Sway repo, then select commits for repos with dependencies (e.g. fuel-core)
by checking the versions that are tested under the Sway commit's integration
testing.</p>
<h3 id="ci"><a class="header" href="#ci">CI</a></h3>
<p>To ensure we maintain availability of milestone binaries in the cache, we build
each of the milestones under the CI workflow.</p>
<p>Currently, the milestones are manually specified. As a result, they'll need
to be updated upon adding new milestones, or removed when they're no longer
officially supported.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="adding-packages"><a class="header" href="#adding-packages">Adding Packages</a></h1>
<p>Adding new packages requires making small updates to multiple sections of
<strong>fuel.nix</strong>:</p>
<h2 id="updating-scriptsrefresh-manifestssh"><a class="header" href="#updating-scriptsrefresh-manifestssh">Updating <code>./scripts/refresh-manifests.sh</code></a></h2>
<p>If the new package requires adding a new repository, first add an entry to the
set of repositories:</p>
<pre><code class="language-sh"># The set of fuel repositories.
declare -A fuel_repos=(
    [forc-wallet]="https://github.com/fuellabs/forc-wallet"
    [fuel-core]="https://github.com/fuellabs/fuel-core"
    [sway]="https://github.com/fuellabs/sway"
    [sway-vim]="https://github.com/fuellabs/sway.vim"
)
</code></pre>
<p>Next, add a dedicated package declaration:</p>
<pre><code class="language-sh"># The set of packages.
declare -A pkg_forc=(
    [name]="forc"
    [repo]="${fuel_repos[sway]}"
)
declare -A pkg_forc_client=(
    [name]="forc-client"
    [repo]="${fuel_repos[sway]}"
)
declare -A pkg_forc_doc=(
    [name]="forc-doc"
    [repo]="${fuel_repos[sway]}"
)
# ...
</code></pre>
<p>Finally, add a call to <code>refresh</code> for the new package:</p>
<pre><code class="language-sh">refresh pkg_forc
refresh pkg_forc_client
refresh pkg_forc_doc
refresh pkg_forc_fmt
refresh pkg_forc_index
refresh pkg_forc_lsp
refresh pkg_forc_tx
refresh pkg_forc_wallet
refresh pkg_fuel_core
refresh pkg_fuel_core_client
refresh pkg_fuel_indexer
</code></pre>
<p>This should ensure that the new package's manifests are generated as a part of
the nightly <code>refresh-manifests</code> CI action.</p>
<h2 id="updating-filtersnix"><a class="header" href="#updating-filtersnix">Updating <code>./filters.nix</code></a></h2>
<p>It's often useful to filter out older versions that will never be tested by the
flake's CI.</p>
<p>We can do so by adding a condition to the list of filters:</p>
<pre><code class="language-nix">  (m: m.pname != "forc" || versionAtLeast m.version "0.19.0")
  (m: m.pname != "forc-client" || versionAtLeast m.version "0.19.0")
  # ...
</code></pre>
<p>See the <a href="contributing/./internals/providing-packages.html#filtering-manifests">Filtering
Manifests</a> section for
more details.</p>
<h2 id="updating-patchesnix"><a class="header" href="#updating-patchesnix">Updating <code>./patches.nix</code></a></h2>
<p>If necessary, add a custom patch for the new package including any necessary
unique attributes, environment variables, etc:</p>
<pre><code class="language-nix">    {
      condition = m: m.pname == "forc-client";
      patch = m: {
        buildAndTestSubdir = "forc-plugins/${m.pname}";
        nativeBuildInputs = [
          pkgs.perl # for openssl-sys
          pkgs.pkg-config # for openssl-sys
        ];
      };
    }
</code></pre>
<p>For more details on how to apply manifest patches, see the
<a href="contributing/./internals/providing-packages.html#patching-manifests">Patching Manifests</a>
section.</p>
<blockquote>
<p><strong>Tip:</strong> Check the new package's upstream CI to get an idea of what system
dependencies, build inputs and environment setup might be required for the
patch.</p>
</blockquote>
<h2 id="updating-milestonesnix"><a class="header" href="#updating-milestonesnix">Updating <code>./milestones.nix</code></a></h2>
<p>If the new package is provided from a new repository, ensure the new repository
is added to the milestones as necessary.</p>
<h2 id="package-sets-1"><a class="header" href="#package-sets-1">Package Sets</a></h2>
<p>The new package should automatically be included as a part of the <code>fuel</code>,
<code>fuel-nightly</code> and milestone package sets.</p>
<h2 id="example-commits"><a class="header" href="#example-commits">Example Commits</a></h2>
<p>The following commits show the basics of adding a new package. In this case,
the <code>forc-client</code> plugin.</p>
<ul>
<li><a href="https://github.com/FuelLabs/fuel.nix/pull/13/commits/ee1045ff1e6ce5df0e7f08aca4ce4cd6e72b3b51"><strong>Add forc-client to the refresh-manifests script</strong></a></li>
<li><a href="https://github.com/FuelLabs/fuel.nix/pull/13/commits/117257429a3055abfe1bb8084be76f5facccfaba"><strong>Add forc-client package to the nix flake</strong></a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="updating-packages"><a class="header" href="#updating-packages">Updating Packages</a></h1>
<p>Every now and then, a new nightly or published version of an upstream package
may add some new dependency or build environment requirement.</p>
<p>In order to avoid breaking older packages or invalidating the cache for existing
versions, we can make the necessary changes for new versions by adding a new
patch to <code>./patches.nix</code>.</p>
<p>See the <a href="contributing/./internals/providing-packages.html#patching-manifests">Patching
Manifests</a> section for
details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="updating-flake-inputs"><a class="header" href="#updating-flake-inputs">Updating Flake Inputs</a></h1>
<p>Nix flakes can be thought of as a collection of pure functions that produce a
plan for how to provide packages, devShells and other outputs.</p>
<p>Any external inputs to these functions must be declared as a part of the flake
inputs. Apart from these, only files available within the flake's repository (or
<a href="https://nixos.org/manual/nixpkgs/stable/#chap-pkgs-fetchers">fetchers</a> that can
verify reproducibility of the fetched content using a hash) may be used to
construct flake outputs.</p>
<p>Here's what <strong>fuel.nix</strong>'s flake inputs look like today:</p>
<pre><code class="language-nix">  inputs = {
    nixpkgs = {
      url = "github:NixOS/nixpkgs/nixos-unstable";
    };
    rust-overlay = {
      url = "github:oxalica/rust-overlay/master";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    sway-vim-src = {
      url = "github:fuellabs/sway.vim";
      flake = false;
    };
    utils = {
      url = "github:numtide/flake-utils";
    };
  };
</code></pre>
<p>Our inputs include:</p>
<ul>
<li><code>nixpkgs</code> - The main nix package repository, providing most packages you could
imagine.</li>
<li><code>rust-overlay</code> - A nixpkgs overlay for providing more fine-grained control
over selecting Rust versions, choosing components, etc. It can be thought of as
a nix-esque version of rustup.</li>
<li><code>sway-vim-src</code> - Unlike the other fuel packages, we only provide the latest
version of the sway-vim plugin. This input provides the repo for the plugin.</li>
<li><code>utils</code> - Some flake utility functions that make it a little easier to provide
outputs for multiple different systems.</li>
</ul>
<h2 id="updating-inputs"><a class="header" href="#updating-inputs">Updating Inputs</a></h2>
<p>Inputs are <strong>locked</strong> to a set of commits via the <code>flake.lock</code> file.
Occasionally it might be necessary to update nixpkgs or rust-overlay in order
to get access to some new version of Rust, a new openssl version with a security
patch, etc.</p>
<p>To update <em>all</em> inputs:</p>
<pre><code class="language-console">nix flake update
</code></pre>
<p>To update a single input:</p>
<pre><code class="language-console">nix flake lock --update-input nixpkgs
</code></pre>
<p>After updating, be sure to commit the changes to the lock file (CI should fail
if you forget). It's best to update inputs in a dedicated PR, as doing so may
have implications on the way package's are built.</p>
<h3 id="cache-implications"><a class="header" href="#cache-implications">Cache Implications</a></h3>
<p>It's worth keeping in mind that updating inputs will result in new derivations
for existing packages in the case that existing packages use something provided
by the updated input that might have changed. As a result, it's better to update
<code>nixpkgs</code> only as necessary.</p>
<p>A possible future solution to this might be to update nixpkgs versions in
the same way that we update Rust versions, i.e. using <code>patches.nix</code>. This may
require a bit of a refactor of <code>patches.nix</code> (e.g. fetch nixpkgs at pinned
commits internally using <a href="https://nixos.org/manual/nixpkgs/stable/#fetchfromgithub"><code>fetchFromGitHub</code></a>, rather than passing in <code>pkgs</code> as an
input), and would likely still require at least one version of nixpkgs as an
input in order to provide useful nix functions via <code>lib</code> outside of the package
outputs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
